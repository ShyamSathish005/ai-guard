/**
 * @ai-guard/core
 * Kernel Logic & Workers
 */
export const WORKER_CODE_PURE = "var Z={CREDIT_CARD:/\\b(?:\\d{4}[ -]?){3}\\d{4}\\b/,EMAIL:/\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/,API_KEY:/\\b(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36})\\b/,SSN:/\\b\\d{3}-\\d{2}-\\d{4}\\b/,IPV4:/\\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b/,AWS_KEY:/\\b(AKIA[0-9A-Z]{16})\\b/,JWT:/\\beyJ[a-zA-Z0-9_-]*\\.eyJ[a-zA-Z0-9_-]*\\.[a-zA-Z0-9_-]*\\b/};function M(r,a={},c=!1,e=[],s=[]){let t={};Array.isArray(a)?t={rules:a,redact:c,allow:e,customRules:s,mode:\"block\"}:t={rules:[],redact:!1,allow:[],customRules:[],mode:\"block\",...a};let{rules:l=[],redact:n=!1,allow:f=[],customRules:p=[],mode:h=\"block\"}=t,i=r,o=[],x=!0,b={...Z};for(let u of p)u.name&&u.pattern&&(b[u.name]=u.pattern);let d=l.length>0?l:Object.keys(b),w=f.map(u=>typeof u==\"string\"?new RegExp(u):u);for(let u of d){let m=b[u];if(!m)continue;let _=new RegExp(m.source,\"g\"),k=r.match(_);if(k&&k.length>0){let S=k.filter(N=>!w.some(J=>J.test(N)));S.length>0&&(x=!1,o.push({type:u,matches:S}))}}if(!x&&(n||h===\"block\"))for(let u of o)for(let m of u.matches)i=i.replace(m,`[${u.type}_REDACTED]`);let g=x?\"safe\":\"blocked\";return!x&&h===\"warn\"&&(g=\"warning\"),{safe:x||h===\"warn\"||h===\"silent\",status:g,findings:o,text:i}}function E(r){if(!r)return\"\";let a=r.trim();return a=a.replace(/^```[a-zA-Z]*\\s*/,\"\"),a=a.replace(/\\s*```$/,\"\"),a}function R(r,a={}){if(!r)return\"\";let{last:c=!0}=a,e=r;e=e.replace(/<think>[\\s\\S]*?<\\/think>/gi,\"\"),e=e.replace(/<think>[\\s\\S]*$/gi,\"\"),e=e.replace(/<\\/th$/gi,\"\");let s=/```(?:json|json5|javascript|js)?\\s*([\\s\\S]*?)(?:```|$)/gi,t=[],l;for(;(l=s.exec(e))!==null;){let d=l[1].trim();d&&(d.startsWith(\"{\")||d.startsWith(\"[\"))&&t.push(d)}if(t.length>0)return c?t[t.length-1]:t[0];let n=[],f=0,p=-1,h=!1,i=!1;for(let d=0;d<e.length;d++){let w=e[d];if(i){i=!1;continue}if(w===\"\\\\\"&&h){i=!0;continue}if(w==='\"'&&!i){h=!h;continue}h||(w===\"{\"||w===\"[\"?(f===0&&(p=d),f++):(w===\"}\"||w===\"]\")&&(f--,f===0&&p!==-1&&(n.push(e.slice(p,d+1)),p=-1)))}if(p!==-1&&f>0&&n.push(e.slice(p)),n.length>0)return c?n[n.length-1]:n[0];let o=e.indexOf(\"{\"),x=e.indexOf(\"[\");if(o===-1&&x===-1)return e.trim();let b=o===-1?x:x===-1?o:Math.min(o,x);return e.slice(b).trim()}function O(r,a={}){let{extract:c=!1}=a,e=c?R(r):E(r);if(!e||!e.trim())return{fixed:\"{}\",data:{},isPartial:!1,patches:[]};let s=e.trim(),t=[],l=!1,n=[],f=!1,p=!1;for(let i=0;i<s.length;i++){let o=s[i];if(p){p=!1;continue}if(o===\"\\\\\"&&f){p=!0;continue}if(o==='\"'&&!p){f=!f,f?n.push('\"'):n.length>0&&n[n.length-1]==='\"'&&n.pop();continue}f||(o===\"{\"?n.push(\"{\"):o===\"[\"?n.push(\"[\"):o===\"}\"?n.length>0&&n[n.length-1]===\"{\"&&n.pop():o===\"]\"&&n.length>0&&n[n.length-1]===\"[\"&&n.pop())}if(f&&(t.push({type:\"unclosed_string\",index:s.length}),s+='\"',l=!0,n.length>0&&n[n.length-1]==='\"'&&n.pop()),/,\\s*$/.test(s)){let i=s.match(/,\\s*$/);t.push({type:\"trailing_comma\",index:i.index}),s=s.replace(/,\\s*$/,\"\"),l=!0}for(;n.length>0;){let i=n.pop();i===\"{\"?(t.push({type:\"missing_brace\",index:s.length}),s+=\"}\",l=!0):i===\"[\"&&(t.push({type:\"missing_brace\",index:s.length}),s+=\"]\",l=!0)}let h=null;try{h=JSON.parse(s)}catch{}return{fixed:s,data:h,isPartial:l,patches:t}}var P=null,I=null,z=!1;async function L(){if(!P){if(!z)throw new Error(\"Wasm Kernel is disabled in this build.\");try{let r=await import(\"../core/repair_wasm.js\");P=await(r.default||r)(),I=P.cwrap(\"repair_json\",\"string\",[\"string\"])}catch(r){throw console.error(\"Failed to load Wasm kernel:\",r),r}}}var y=new Map,A=new Map;async function W(r){let{name:a,url:c,module:e}=r;if(y.has(a))return{success:!0,name:a,cached:!0};if(A.has(a))return await A.get(a),{success:!0,name:a,cached:!0};let s=(async()=>{try{let t;if(e)t=e;else if(c)t=await import(c);else throw new Error(\"Plugin requires either url or module\");return typeof t.init==\"function\"&&await t.init(),y.set(a,t),t}catch(t){throw A.delete(a),t}})();return A.set(a,s),await s,{success:!0,name:a}}async function j(r,a=null){let c=[],e=a?a.filter(s=>y.has(s)):Array.from(y.keys());for(let s of e){let t=y.get(s);if(t&&typeof t.check==\"function\")try{let l=await t.check(r);if(c.push({name:s,...l}),!l.safe)return{safe:!1,blockedBy:s,reason:l.reason||\"Plugin blocked\",score:l.score,results:c}}catch(l){c.push({name:s,error:l.message})}}return{safe:!0,results:c}}self.onmessage=async r=>{let{id:a,type:c,payload:e,options:s}=r.data;try{let t;switch(c){case\"LOAD_PLUGIN\":t=await W(e);break;case\"UNLOAD_PLUGIN\":let l=typeof e==\"string\"?e:e.name;y.delete(l),A.delete(l),t={success:!0,name:l};break;case\"LIST_PLUGINS\":t={plugins:Array.from(y.keys())};break;case\"SCAN_TEXT\":let n=typeof e==\"string\"?e:e?.text,f=s?.rules||e?.enabledRules||[],p=s?.redact??e?.redact??!1,h=s?.allow||e?.allow||[],i=s?.customRules||e?.customRules||[],o=s?.runPlugins??e?.runPlugins??!0,x=s?.plugins||e?.plugins||null;if(t=M(n,f,p,h,i),t.safe&&o&&y.size>0){let g=await j(n,x);g.safe?t.pluginResults=g.results:t={...t,safe:!1,blockedBy:g.blockedBy,reason:g.reason,score:g.score,pluginResults:g.results}}break;case\"REPAIR_JSON\":{let g=typeof e==\"string\"?e:e?.text,T=s?.extract??e?.extract??!1,u=s?.useWasm&&z,m;if(u){P||await L();let S=T?R(g):E(g);m={fixed:I(S),data:null,isPartial:!1,patches:[]}}else m=O(g,{extract:T});let _=m.data,k=!0;if(_===null&&m.fixed!==\"null\")try{_=JSON.parse(m.fixed)}catch{k=!1}t={fixedString:m.fixed,data:_,isValid:k,isPartial:m.isPartial,patches:m.patches,mode:u?\"wasm\":\"js\"}}break;case\"EXTRACT_JSON\":let b=typeof e==\"string\"?e:e?.text,d=s?.last??e?.last??!0;t={extracted:R(b,{last:d})};break;default:throw new Error(`Unknown message type: ${c}`)}self.postMessage({id:a,success:!0,payload:t})}catch(t){self.postMessage({id:a,success:!1,error:t.message})}};\n";
export const WORKER_CODE_PRO = "var le=Object.defineProperty;var Xe=(l,s,r)=>s in l?le(l,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[s]=r;var Ye=(l,s)=>()=>(l&&(s=l(l=0)),s);var Qe=(l,s)=>{for(var r in s)le(l,r,{get:s[r],enumerable:!0})};var ce=(l,s,r)=>Xe(l,typeof s!=\"symbol\"?s+\"\":s,r);var Ae={};Qe(Ae,{default:()=>rt});async function tt(l={}){var s,r=l,n=!!globalThis.window,o=!!globalThis.WorkerGlobalScope,i=globalThis.process?.versions?.node&&globalThis.process?.type!=\"renderer\",A=[],c=\"./this.program\",v=import.meta.url,w=\"\",b,p;if(n||o){try{w=new URL(\".\",v).href}catch{}o&&(p=e=>{var t=new XMLHttpRequest;return t.open(\"GET\",e,!1),t.responseType=\"arraybuffer\",t.send(null),new Uint8Array(t.response)}),b=async e=>{var t=await fetch(e,{credentials:\"same-origin\"});if(t.ok)return t.arrayBuffer();throw new Error(t.status+\" : \"+t.url)}}var y=console.log.bind(console),E=console.error.bind(console),T,R=!1;function P(e){for(var t=0,a=e.length,f=new Uint8Array(a),h;t<a;++t)h=e.charCodeAt(t),f[t]=~h>>8&h;return f}var S,I,m,_,U,j,W,H,q,he,de,ye,L=!1;function ve(){var e=ie.buffer;m=new Int8Array(e),U=new Int16Array(e),_=new Uint8Array(e),j=new Uint16Array(e),W=new Int32Array(e),H=new Uint32Array(e),q=new Float32Array(e),he=new Float64Array(e),de=new BigInt64Array(e),ye=new BigUint64Array(e)}function we(){if(r.preRun)for(typeof r.preRun==\"function\"&&(r.preRun=[r.preRun]);r.preRun.length;)Ne(r.preRun.shift());K(Y)}function Re(){L=!0,O.b()}function _e(){if(r.postRun)for(typeof r.postRun==\"function\"&&(r.postRun=[r.postRun]);r.postRun.length;)xe(r.postRun.shift());K(X)}function be(e){r.onAbort?.(e),e=\"Aborted(\"+e+\")\",E(e),R=!0,e+=\". Build with -sASSERTIONS for more info.\";var t=new WebAssembly.RuntimeError(e);throw I?.(t),t}var V;function Ee(){return P('\\0asm\u0001\\0\\0\\0\u0001\u0011\u0004`\u0001\\x7F\u0001\\x7F`\\0\u0001\\x7F`\u0001\\x7F\\0`\\0\\0\u0003\u0006\u0005\u0001\\0\u0002\\0\u0003\u0005\\x07\u0001\u0001\\xA2\u0002\\x80\\x80\u0002\u0006\t\u0001\\x7F\u0001A\\x90\\x90\\x84\u0001\\v\\x07\u0019\u0006\u0001a\u0002\\0\u0001b\\0\u0004\u0001c\\0\u0003\u0001d\\0\u0002\u0001e\\0\u0001\u0001f\\0\\0\\f\u0001\u0001\\n\\xC1\u0005\u0005\u0004\\0#\\0\\v\u0010\\0#\\0 \\0kApq\"\\0$\\0 \\0\\v\u0006\\0 \\0$\\0\\v\\x9E\u0005\u0001\\b\\x7FA\\x7F!\u0001A\\x80\\bA\\x7F6\u0002\\0\u0002@\u0002\\x7F\u0002@\u0002@ \\0\"\\x07A\u0003qE\\r\\0A\\0 \\0-\\0\\0E\\r\u0002\u001a\u0003@ \\0A\u0001j\"\\0A\u0003qE\\r\u0001 \\0-\\0\\0\\r\\0\\v\\f\u0001\\v\u0003@ \\0\"\u0005A\u0004j!\\0A\\x80\\x82\\x84\\b \u0005(\u0002\\0\"\\bk \\brA\\x80\\x81\\x82\\x84xqA\\x80\\x81\\x82\\x84xF\\r\\0\\v\u0003@ \u0005\"\\0A\u0001j!\u0005 \\0-\\0\\0\\r\\0\\v\\v \\0 \\x07k\\v\"\u0005A\\0L\\r\\0\u0002\\x7F\u0003@A\\xFF\\xFF\\xFF\\0 \u0002A\\xFF\\xFF\\xFF\\0F\\r\u0001\u001a \u0002 \u0002 \\x07j-\\0\\0\"\\0:\\0\\x90\u0010 \u0006A\u0001q!\u0003A\\0!\u0006\u0002@ \u0003\\r\\0 \\0A\\xDC\\0F\u0004@A\u0001!\u0006\\f\u0001\\v \\0A\"F\u0004@ \u0004A\u0001s!\u0004\\f\u0001\\v \u0004A\u0001q\u0004@A\u0001!\u0004\\f\u0001\\v\u0002@\u0002@\u0002@ \\0A\\xDB\\0G\u0004@ \\0A\\xFB\\0G\\r\u0001 \u0001A\\xFE\\x07J\\r\u0002A\\0!\u0004A\\x80\\b \u0001A\u0001j\"\\x006\u0002\\0 \u0001A\\x91\\bjA\\xFD\\0:\\0\\0 \\0!\u0001\\f\u0003\\v \u0001A\\xFE\\x07J\\r\u0001A\\0!\u0004A\\x80\\b \u0001A\u0001j\"\\x006\u0002\\0 \u0001A\\x91\\bjA\\xDD\\0:\\0\\0 \\0!\u0001\\f\u0002\\vA\\0!\u0004 \\0A\\xDF\u0001qA\\xDD\\0G\\r\u0001 \u0001A\\0H\\r\u0001 \u0001-\\0\\x90\\b \\0G\\r\u0001A\\x80\\b \u0001A\u0001k\"\u00016\u0002\\0\\f\u0001\\vA\\0!\u0004\\v\\v \u0002A\u0001j\"\u0002 \u0005G\\r\\0\\v \u0005\\v!\u0003 \u0004A\u0001q\u0004@ \u0003A\":\\0\\x90\u0010 \u0003A\u0001j!\u0003\\vA\\0!\u0006 \u0001A\\0H\\r\\0\u0002@ \u0001A\u0003qA\u0003F\u0004@ \u0001!\u0002\\f\u0001\\v \u0001A\u0001jA\u0003q!\\0 \u0001!\u0002\u0003@ \u0003A\\x90\u0010j \u0002-\\0\\x90\\b:\\0\\0 \u0003A\u0001j!\u0003 \u0002A\u0001k!\u0002 \u0006A\u0001j\"\u0006 \\0G\\r\\0\\v\\v \u0001A\u0003O\u0004@\u0003@ \u0003A\\x90\u0010j \u0002A\\x90\\bj-\\0\\0:\\0\\0 \u0003A\\x91\u0010j \u0002A\\x8F\\bj-\\0\\0:\\0\\0 \u0003A\\x92\u0010j \u0002A\\x8E\\bj-\\0\\0:\\0\\0 \u0003A\\x93\u0010j \u0002A\\x8D\\bj-\\0\\0:\\0\\0 \u0003A\u0004j!\u0003 \u0002A\u0003G \u0002A\u0004k!\u0002\\r\\0\\v\\vA\\x80\\bA\\x7F6\u0002\\0\\v \u0003A\\x90\u0010jA\\0:\\0\\0A\\x90\u0010\\v\u0002\\0\\v\\v\\v\u0001\\0A\\x80\\b\\v\u0004\\xFF\\xFF\\xFF\\xFF')}function it(e){return e}async function Se(e){return e}async function ke(e,t){try{var a=await Se(e),f=await WebAssembly.instantiate(a,t);return f}catch(h){E(`failed to asynchronously prepare wasm: ${h}`),be(h)}}async function Pe(e,t,a){return ke(t,a)}function Te(){var e={a:Le};return e}async function je(){function e(d,u){return O=d.exports,Ze(O),ve(),O}function t(d){return e(d.instance)}var a=Te();if(r.instantiateWasm)return new Promise((d,u)=>{r.instantiateWasm(a,(g,N)=>{d(e(g,N))})});V??(V=Ee());var f=await Pe(T,V,a),h=t(f);return h}class ot{constructor(t){ce(this,\"name\",\"ExitStatus\");this.message=`Program terminated with exit(${t})`,this.status=t}}for(var K=e=>{for(;e.length>0;)e.shift()(r)},X=[],xe=e=>X.push(e),Y=[],Ne=e=>Y.push(e),Be=!0,Ue=e=>ne(e),Me=()=>se(),Q=e=>{var t=r[\"_\"+e];return t},Ce=(e,t)=>{m.set(e,t)},Ie=e=>{for(var t=0,a=0;a<e.length;++a){var f=e.charCodeAt(a);f<=127?t++:f<=2047?t+=2:f>=55296&&f<=57343?(t+=4,++a):t+=3}return t},We=(e,t,a,f)=>{if(!(f>0))return 0;for(var h=a,d=a+f-1,u=0;u<e.length;++u){var g=e.codePointAt(u);if(g<=127){if(a>=d)break;t[a++]=g}else if(g<=2047){if(a+1>=d)break;t[a++]=192|g>>6,t[a++]=128|g&63}else if(g<=65535){if(a+2>=d)break;t[a++]=224|g>>12,t[a++]=128|g>>6&63,t[a++]=128|g&63}else{if(a+3>=d)break;t[a++]=240|g>>18,t[a++]=128|g>>12&63,t[a++]=128|g>>6&63,t[a++]=128|g&63,u++}}return t[a]=0,a-h},Fe=(e,t,a)=>We(e,_,t,a),ee=e=>ae(e),Oe=e=>{var t=Ie(e)+1,a=ee(t);return Fe(e,a,t),a},te=globalThis.TextDecoder&&new TextDecoder,De=(e,t,a,f)=>{var h=t+a;if(f)return h;for(;e[t]&&!(t>=h);)++t;return t},ze=(e,t=0,a,f)=>{var h=De(e,t,a,f);if(h-t>16&&e.buffer&&te)return te.decode(e.subarray(t,h));for(var d=\"\";t<h;){var u=e[t++];if(!(u&128)){d+=String.fromCharCode(u);continue}var g=e[t++]&63;if((u&224)==192){d+=String.fromCharCode((u&31)<<6|g);continue}var N=e[t++]&63;if((u&240)==224?u=(u&15)<<12|g<<6|N:u=(u&7)<<18|g<<12|N<<6|e[t++]&63,u<65536)d+=String.fromCharCode(u);else{var M=u-65536;d+=String.fromCharCode(55296|M>>10,56320|M&1023)}}return d},He=(e,t,a)=>e?ze(_,e,t,a):\"\",re=(e,t,a,f,h)=>{var d={string:k=>{var D=0;return k!=null&&k!==0&&(D=Oe(k)),D},array:k=>{var D=ee(k.length);return Ce(k,D),D}};function u(k){return t===\"string\"?He(k):t===\"boolean\"?!!k:k}var g=Q(e),N=[],M=0;if(f)for(var C=0;C<f.length;C++){var oe=d[a[C]];oe?(M===0&&(M=Me()),N[C]=oe(f[C])):N[C]=f[C]}var G=g(...N);function Ke(k){return M!==0&&Ue(M),u(k)}return G=Ke(G),G},Je=(e,t,a,f)=>{var h=!a||a.every(u=>u===\"number\"||u===\"boolean\"),d=t!==\"string\";return d&&h&&!f?Q(e):(...u)=>re(e,t,a,u,f)},F=new Uint8Array(123),x=25;x>=0;--x)F[48+x]=52+x,F[65+x]=x,F[97+x]=26+x;if(F[43]=62,F[47]=63,r.noExitRuntime&&(Be=r.noExitRuntime),r.print&&(y=r.print),r.printErr&&(E=r.printErr),r.wasmBinary&&(T=r.wasmBinary),r.arguments&&(A=r.arguments),r.thisProgram&&(c=r.thisProgram),r.preInit)for(typeof r.preInit==\"function\"&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.shift()();r.ccall=re,r.cwrap=Je;var $e,ne,ae,se,qe,Ge,ie;function Ze(e){$e=r._repair_json=e.c,ne=e.d,ae=e.e,se=e.f,qe=ie=e.a,Ge=e.__indirect_function_table}var Le={};function Ve(){we();function e(){r.calledRun=!0,!R&&(Re(),S?.(r),r.onRuntimeInitialized?.(),_e())}r.setStatus?(r.setStatus(\"Running...\"),setTimeout(()=>{setTimeout(()=>r.setStatus(\"\"),1),e()},1)):e()}var O;return O=await je(),Ve(),L?s=r:s=new Promise((e,t)=>{S=e,I=t}),s}var rt,pe=Ye(()=>{rt=tt});var et={CREDIT_CARD:/\\b(?:\\d{4}[ -]?){3}\\d{4}\\b/,EMAIL:/\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/,API_KEY:/\\b(sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36})\\b/,SSN:/\\b\\d{3}-\\d{2}-\\d{4}\\b/,IPV4:/\\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b/,AWS_KEY:/\\b(AKIA[0-9A-Z]{16})\\b/,JWT:/\\beyJ[a-zA-Z0-9_-]*\\.eyJ[a-zA-Z0-9_-]*\\.[a-zA-Z0-9_-]*\\b/};function fe(l,s={},r=!1,n=[],o=[]){let i={};Array.isArray(s)?i={rules:s,redact:r,allow:n,customRules:o,mode:\"block\"}:i={rules:[],redact:!1,allow:[],customRules:[],mode:\"block\",...s};let{rules:A=[],redact:c=!1,allow:v=[],customRules:w=[],mode:b=\"block\"}=i,p=l,y=[],E=!0,T={...et};for(let m of w)m.name&&m.pattern&&(T[m.name]=m.pattern);let R=A.length>0?A:Object.keys(T),P=v.map(m=>typeof m==\"string\"?new RegExp(m):m);for(let m of R){let _=T[m];if(!_)continue;let U=new RegExp(_.source,\"g\"),j=l.match(U);if(j&&j.length>0){let W=j.filter(H=>!P.some(q=>q.test(H)));W.length>0&&(E=!1,y.push({type:m,matches:W}))}}if(!E&&(c||b===\"block\"))for(let m of y)for(let _ of m.matches)p=p.replace(_,`[${m.type}_REDACTED]`);let S=E?\"safe\":\"blocked\";return!E&&b===\"warn\"&&(S=\"warning\"),{safe:E||b===\"warn\"||b===\"silent\",status:S,findings:y,text:p}}function Z(l){if(!l)return\"\";let s=l.trim();return s=s.replace(/^```[a-zA-Z]*\\s*/,\"\"),s=s.replace(/\\s*```$/,\"\"),s}function J(l,s={}){if(!l)return\"\";let{last:r=!0}=s,n=l;n=n.replace(/<think>[\\s\\S]*?<\\/think>/gi,\"\"),n=n.replace(/<think>[\\s\\S]*$/gi,\"\"),n=n.replace(/<\\/th$/gi,\"\");let o=/```(?:json|json5|javascript|js)?\\s*([\\s\\S]*?)(?:```|$)/gi,i=[],A;for(;(A=o.exec(n))!==null;){let R=A[1].trim();R&&(R.startsWith(\"{\")||R.startsWith(\"[\"))&&i.push(R)}if(i.length>0)return r?i[i.length-1]:i[0];let c=[],v=0,w=-1,b=!1,p=!1;for(let R=0;R<n.length;R++){let P=n[R];if(p){p=!1;continue}if(P===\"\\\\\"&&b){p=!0;continue}if(P==='\"'&&!p){b=!b;continue}b||(P===\"{\"||P===\"[\"?(v===0&&(w=R),v++):(P===\"}\"||P===\"]\")&&(v--,v===0&&w!==-1&&(c.push(n.slice(w,R+1)),w=-1)))}if(w!==-1&&v>0&&c.push(n.slice(w)),c.length>0)return r?c[c.length-1]:c[0];let y=n.indexOf(\"{\"),E=n.indexOf(\"[\");if(y===-1&&E===-1)return n.trim();let T=y===-1?E:E===-1?y:Math.min(y,E);return n.slice(T).trim()}function ue(l,s={}){let{extract:r=!1}=s,n=r?J(l):Z(l);if(!n||!n.trim())return{fixed:\"{}\",data:{},isPartial:!1,patches:[]};let o=n.trim(),i=[],A=!1,c=[],v=!1,w=!1;for(let p=0;p<o.length;p++){let y=o[p];if(w){w=!1;continue}if(y===\"\\\\\"&&v){w=!0;continue}if(y==='\"'&&!w){v=!v,v?c.push('\"'):c.length>0&&c[c.length-1]==='\"'&&c.pop();continue}v||(y===\"{\"?c.push(\"{\"):y===\"[\"?c.push(\"[\"):y===\"}\"?c.length>0&&c[c.length-1]===\"{\"&&c.pop():y===\"]\"&&c.length>0&&c[c.length-1]===\"[\"&&c.pop())}if(v&&(i.push({type:\"unclosed_string\",index:o.length}),o+='\"',A=!0,c.length>0&&c[c.length-1]==='\"'&&c.pop()),/,\\s*$/.test(o)){let p=o.match(/,\\s*$/);i.push({type:\"trailing_comma\",index:p.index}),o=o.replace(/,\\s*$/,\"\"),A=!0}for(;c.length>0;){let p=c.pop();p===\"{\"?(i.push({type:\"missing_brace\",index:o.length}),o+=\"}\",A=!0):p===\"[\"&&(i.push({type:\"missing_brace\",index:o.length}),o+=\"]\",A=!0)}let b=null;try{b=JSON.parse(o)}catch{}return{fixed:o,data:b,isPartial:A,patches:i}}var $=null,ge=null,me=!0;async function nt(){if(!$){if(!me)throw new Error(\"Wasm Kernel is disabled in this build.\");try{let l=await Promise.resolve().then(()=>(pe(),Ae));$=await(l.default||l)(),ge=$.cwrap(\"repair_json\",\"string\",[\"string\"])}catch(l){throw console.error(\"Failed to load Wasm kernel:\",l),l}}}var B=new Map,z=new Map;async function at(l){let{name:s,url:r,module:n}=l;if(B.has(s))return{success:!0,name:s,cached:!0};if(z.has(s))return await z.get(s),{success:!0,name:s,cached:!0};let o=(async()=>{try{let i;if(n)i=n;else if(r)i=await import(r);else throw new Error(\"Plugin requires either url or module\");return typeof i.init==\"function\"&&await i.init(),B.set(s,i),i}catch(i){throw z.delete(s),i}})();return z.set(s,o),await o,{success:!0,name:s}}async function st(l,s=null){let r=[],n=s?s.filter(o=>B.has(o)):Array.from(B.keys());for(let o of n){let i=B.get(o);if(i&&typeof i.check==\"function\")try{let A=await i.check(l);if(r.push({name:o,...A}),!A.safe)return{safe:!1,blockedBy:o,reason:A.reason||\"Plugin blocked\",score:A.score,results:r}}catch(A){r.push({name:o,error:A.message})}}return{safe:!0,results:r}}self.onmessage=async l=>{let{id:s,type:r,payload:n,options:o}=l.data;try{let i;switch(r){case\"LOAD_PLUGIN\":i=await at(n);break;case\"UNLOAD_PLUGIN\":let A=typeof n==\"string\"?n:n.name;B.delete(A),z.delete(A),i={success:!0,name:A};break;case\"LIST_PLUGINS\":i={plugins:Array.from(B.keys())};break;case\"SCAN_TEXT\":let c=typeof n==\"string\"?n:n?.text,v=o?.rules||n?.enabledRules||[],w=o?.redact??n?.redact??!1,b=o?.allow||n?.allow||[],p=o?.customRules||n?.customRules||[],y=o?.runPlugins??n?.runPlugins??!0,E=o?.plugins||n?.plugins||null;if(i=fe(c,v,w,b,p),i.safe&&y&&B.size>0){let S=await st(c,E);S.safe?i.pluginResults=S.results:i={...i,safe:!1,blockedBy:S.blockedBy,reason:S.reason,score:S.score,pluginResults:S.results}}break;case\"REPAIR_JSON\":{let S=typeof n==\"string\"?n:n?.text,I=o?.extract??n?.extract??!1,m=o?.useWasm&&me,_;if(m){$||await nt();let W=I?J(S):Z(S);_={fixed:ge(W),data:null,isPartial:!1,patches:[]}}else _=ue(S,{extract:I});let U=_.data,j=!0;if(U===null&&_.fixed!==\"null\")try{U=JSON.parse(_.fixed)}catch{j=!1}i={fixedString:_.fixed,data:U,isValid:j,isPartial:_.isPartial,patches:_.patches,mode:m?\"wasm\":\"js\"}}break;case\"EXTRACT_JSON\":let T=typeof n==\"string\"?n:n?.text,R=o?.last??n?.last??!0;i={extracted:J(T,{last:R})};break;default:throw new Error(`Unknown message type: ${r}`)}self.postMessage({id:s,success:!0,payload:i})}catch(i){self.postMessage({id:s,success:!1,error:i.message})}};\n";

export { scanText } from './scanner.js';
export { repairJSON, extractJSON } from './repair.js';
export { registerProfile, getProfile } from './registry.js';
export { SchemaEngine } from './SchemaEngine.js';
